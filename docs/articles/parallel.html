<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Parallel processing • mikropml</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Parallel processing" />
<meta property="og:description" content="mikropml" />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mikropml</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/SchlossLab/mikropml/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>


<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Parallel processing</h1>
            
      
      <small class="dont-index">Source: <a href='https://github.com/SchlossLab/mikropml/blob/master/vignettes/parallel.Rmd'><code>vignettes/parallel.Rmd</code></a></small>
      <div class="hidden name"><code>parallel.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">library</span>(mikropml)</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw">library</span>(future.apply)</a>
<a class="sourceLine" id="cb1-3" title="3"><span class="co">#&gt; Loading required package: future</span></a></code></pre></div>
<div id="speed-up-single-runs" class="section level2">
<h2>Speed up single runs</h2>
<p>By default, <code>preprocess_data()</code> and <code>run_ml()</code> use only one process in series. If you’d like to parallelize various steps of the pipeline to make them run faster, install <code>foreach</code>, <code>future</code>, <code>future.apply</code>, and <code>doFuture</code>. Then, register a future plan prior to calling <code>preprocess_data()</code> and <code>run_ml()</code>.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1">doFuture<span class="op">::</span><span class="kw">registerDoFuture</span>()</a>
<a class="sourceLine" id="cb2-2" title="2">future<span class="op">::</span><span class="kw">plan</span>(future<span class="op">::</span>multicore, <span class="dt">workers =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb2-3" title="3">otu_data_preproc &lt;-<span class="st"> </span><span class="kw">preprocess_data</span>(otu_small, <span class="st">&#39;dx&#39;</span>)<span class="op">$</span>dat_transformed</a>
<a class="sourceLine" id="cb2-4" title="4">result1 &lt;-<span class="st"> </span><span class="kw">run_ml</span>(otu_data_preproc, <span class="st">&#39;regLogistic&#39;</span>, <span class="dt">seed =</span> <span class="dv">2019</span>)</a>
<a class="sourceLine" id="cb2-5" title="5"><span class="co">#&gt; Using &#39;dx&#39; as the outcome column and &#39;cancer&#39; as the outcome value of interest.</span></a>
<a class="sourceLine" id="cb2-6" title="6"><span class="co">#&gt; Using L2 normalization for Logistic Regression</span></a>
<a class="sourceLine" id="cb2-7" title="7"><span class="co">#&gt; Loading required package: globals</span></a>
<a class="sourceLine" id="cb2-8" title="8"><span class="co">#&gt; Loading required package: foreach</span></a>
<a class="sourceLine" id="cb2-9" title="9"><span class="co">#&gt; Loading required package: iterators</span></a>
<a class="sourceLine" id="cb2-10" title="10"><span class="co">#&gt; Loading required package: parallel</span></a>
<a class="sourceLine" id="cb2-11" title="11"><span class="co">#&gt; Loading required package: lattice</span></a>
<a class="sourceLine" id="cb2-12" title="12"><span class="co">#&gt; Loading required package: ggplot2</span></a>
<a class="sourceLine" id="cb2-13" title="13"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb2-14" title="14"><span class="co">#&gt; Attaching package: &#39;caret&#39;</span></a>
<a class="sourceLine" id="cb2-15" title="15"><span class="co">#&gt; The following object is masked from &#39;package:future&#39;:</span></a>
<a class="sourceLine" id="cb2-16" title="16"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb2-17" title="17"><span class="co">#&gt;     cluster</span></a></code></pre></div>
<p>Above, we used the <code>multicore</code> plan to split the work across 2 cores. See the <a href="https://cran.r-project.org/web/packages/future/vignettes/future-1-overview.html"><code>future</code> documentation</a> for more about picking the best plan for your use case. Notably, <code>multicore</code> does not work inside RStudio or on Windows; you will need to use <code>multisession</code> instead in those cases.</p>
</div>
<div id="call-run_ml-multiple-times-in-parallel-in-r" class="section level2">
<h2>Call <code>run_ml()</code> multiple times in parallel in R</h2>
<p>You can use functions from the <code>future.apply</code> package to call <code>run_ml()</code> multiple times in parallel with different parameters. You will first need to run <code>future::plan()</code> as above if you haven’t already. Then, call <code>run_ml()</code> with multiple seeds using <code>future_lapply()</code>:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1">results_multi &lt;-<span class="st"> </span><span class="kw">future_lapply</span>(<span class="kw">seq</span>(<span class="dv">100</span>, <span class="dv">104</span>), <span class="cf">function</span>(seed) {</a>
<a class="sourceLine" id="cb3-2" title="2">  <span class="kw">run_ml</span>(otu_data_preproc, <span class="st">&#39;regLogistic&#39;</span>, <span class="dt">seed =</span> seed)</a>
<a class="sourceLine" id="cb3-3" title="3">  })</a>
<a class="sourceLine" id="cb3-4" title="4"><span class="co">#&gt; Using &#39;dx&#39; as the outcome column and &#39;cancer&#39; as the outcome value of interest.</span></a>
<a class="sourceLine" id="cb3-5" title="5"><span class="co">#&gt; Using L2 normalization for Logistic Regression</span></a>
<a class="sourceLine" id="cb3-6" title="6"><span class="co">#&gt; Using &#39;dx&#39; as the outcome column and &#39;cancer&#39; as the outcome value of interest.</span></a>
<a class="sourceLine" id="cb3-7" title="7"><span class="co">#&gt; Using L2 normalization for Logistic Regression</span></a>
<a class="sourceLine" id="cb3-8" title="8"><span class="co">#&gt; Using &#39;dx&#39; as the outcome column and &#39;cancer&#39; as the outcome value of interest.</span></a>
<a class="sourceLine" id="cb3-9" title="9"><span class="co">#&gt; Using L2 normalization for Logistic Regression</span></a>
<a class="sourceLine" id="cb3-10" title="10"><span class="co">#&gt; Using &#39;dx&#39; as the outcome column and &#39;cancer&#39; as the outcome value of interest.</span></a>
<a class="sourceLine" id="cb3-11" title="11"><span class="co">#&gt; Using L2 normalization for Logistic Regression</span></a>
<a class="sourceLine" id="cb3-12" title="12"><span class="co">#&gt; Using &#39;dx&#39; as the outcome column and &#39;cancer&#39; as the outcome value of interest.</span></a>
<a class="sourceLine" id="cb3-13" title="13"><span class="co">#&gt; Using L2 normalization for Logistic Regression</span></a></code></pre></div>
<p>Each call to <code>run_ml()</code> with a different seed uses a different random split of the data into training and testing sets. This example uses only 5 seeds for speed and simplicity, but for real data we recommend using many more seeds to get a better estimate of model performance.</p>
<p>Extract the performance results and combine into one dataframe for all seeds:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1">perf_df &lt;-<span class="st"> </span><span class="kw">future_lapply</span>(results_multi, <span class="cf">function</span>(result) {</a>
<a class="sourceLine" id="cb4-2" title="2">  result[[<span class="st">&#39;performance&#39;</span>]]</a>
<a class="sourceLine" id="cb4-3" title="3">  }) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb4-4" title="4"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">bind_rows</span>()</a>
<a class="sourceLine" id="cb4-5" title="5">perf_df</a>
<a class="sourceLine" id="cb4-6" title="6"><span class="co">#&gt; # A tibble: 5 x 5</span></a>
<a class="sourceLine" id="cb4-7" title="7"><span class="co">#&gt;   cv_auroc test_auroc test_auprc method       seed</span></a>
<a class="sourceLine" id="cb4-8" title="8"><span class="co">#&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt; &lt;chr&gt;       &lt;int&gt;</span></a>
<a class="sourceLine" id="cb4-9" title="9"><span class="co">#&gt; 1    0.695      0.468      0.504 regLogistic   100</span></a>
<a class="sourceLine" id="cb4-10" title="10"><span class="co">#&gt; 2    0.644      0.618      0.616 regLogistic   101</span></a>
<a class="sourceLine" id="cb4-11" title="11"><span class="co">#&gt; 3    0.665      0.553      0.606 regLogistic   102</span></a>
<a class="sourceLine" id="cb4-12" title="12"><span class="co">#&gt; 4    0.643      0.655      0.646 regLogistic   103</span></a>
<a class="sourceLine" id="cb4-13" title="13"><span class="co">#&gt; 5    0.648      0.618      0.644 regLogistic   104</span></a></code></pre></div>
<div id="multiple-ml-methods" class="section level3">
<h3>Multiple ML methods</h3>
<p>You may also wish to compare performance for different ML methods. <code>mapply()</code> can iterate over multiple lists or vectors, and <code>future_mapply()</code> works the same way:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"><span class="co"># </span><span class="al">NOTE</span><span class="co">: use more seeds for real-world data</span></a>
<a class="sourceLine" id="cb5-2" title="2">param_grid &lt;-<span class="st"> </span><span class="kw">expand.grid</span>(<span class="dt">seeds =</span> <span class="kw">seq</span>(<span class="dv">100</span>, <span class="dv">104</span>),</a>
<a class="sourceLine" id="cb5-3" title="3">                          <span class="dt">methods =</span> <span class="kw">c</span>(<span class="st">&#39;regLogistic&#39;</span>, <span class="st">&#39;rf&#39;</span>))</a>
<a class="sourceLine" id="cb5-4" title="4">results_mtx &lt;-<span class="st"> </span><span class="kw">future_mapply</span>(<span class="cf">function</span>(seed, method) {</a>
<a class="sourceLine" id="cb5-5" title="5">                             <span class="kw">run_ml</span>(otu_data_preproc, method, <span class="dt">seed =</span> seed)</a>
<a class="sourceLine" id="cb5-6" title="6">                             },</a>
<a class="sourceLine" id="cb5-7" title="7">                             param_grid<span class="op">$</span>seeds, </a>
<a class="sourceLine" id="cb5-8" title="8">                             param_grid<span class="op">$</span>methods)</a>
<a class="sourceLine" id="cb5-9" title="9"><span class="co">#&gt; Using &#39;dx&#39; as the outcome column and &#39;cancer&#39; as the outcome value of interest.</span></a>
<a class="sourceLine" id="cb5-10" title="10"><span class="co">#&gt; Using L2 normalization for Logistic Regression</span></a>
<a class="sourceLine" id="cb5-11" title="11"><span class="co">#&gt; Using &#39;dx&#39; as the outcome column and &#39;cancer&#39; as the outcome value of interest.</span></a>
<a class="sourceLine" id="cb5-12" title="12"><span class="co">#&gt; Using L2 normalization for Logistic Regression</span></a>
<a class="sourceLine" id="cb5-13" title="13"><span class="co">#&gt; Using &#39;dx&#39; as the outcome column and &#39;cancer&#39; as the outcome value of interest.</span></a>
<a class="sourceLine" id="cb5-14" title="14"><span class="co">#&gt; Using L2 normalization for Logistic Regression</span></a>
<a class="sourceLine" id="cb5-15" title="15"><span class="co">#&gt; Using &#39;dx&#39; as the outcome column and &#39;cancer&#39; as the outcome value of interest.</span></a>
<a class="sourceLine" id="cb5-16" title="16"><span class="co">#&gt; Using L2 normalization for Logistic Regression</span></a>
<a class="sourceLine" id="cb5-17" title="17"><span class="co">#&gt; Using &#39;dx&#39; as the outcome column and &#39;cancer&#39; as the outcome value of interest.</span></a>
<a class="sourceLine" id="cb5-18" title="18"><span class="co">#&gt; Using L2 normalization for Logistic Regression</span></a>
<a class="sourceLine" id="cb5-19" title="19"><span class="co">#&gt; Using &#39;dx&#39; as the outcome column and &#39;cancer&#39; as the outcome value of interest.</span></a>
<a class="sourceLine" id="cb5-20" title="20"><span class="co">#&gt; Using &#39;dx&#39; as the outcome column and &#39;cancer&#39; as the outcome value of interest.</span></a>
<a class="sourceLine" id="cb5-21" title="21"><span class="co">#&gt; Using &#39;dx&#39; as the outcome column and &#39;cancer&#39; as the outcome value of interest.</span></a>
<a class="sourceLine" id="cb5-22" title="22"><span class="co">#&gt; Using &#39;dx&#39; as the outcome column and &#39;cancer&#39; as the outcome value of interest.</span></a>
<a class="sourceLine" id="cb5-23" title="23"><span class="co">#&gt; Using &#39;dx&#39; as the outcome column and &#39;cancer&#39; as the outcome value of interest.</span></a></code></pre></div>
<p>Extract and combine the performance results for all seeds and methods:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1">perf_df2 &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">bind_rows</span>(results_mtx[<span class="st">&#39;performance&#39;</span>,])</a>
<a class="sourceLine" id="cb6-2" title="2">perf_df2</a>
<a class="sourceLine" id="cb6-3" title="3"><span class="co">#&gt; # A tibble: 10 x 5</span></a>
<a class="sourceLine" id="cb6-4" title="4"><span class="co">#&gt;    cv_auroc test_auroc test_auprc method       seed</span></a>
<a class="sourceLine" id="cb6-5" title="5"><span class="co">#&gt;       &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt; &lt;fct&gt;       &lt;int&gt;</span></a>
<a class="sourceLine" id="cb6-6" title="6"><span class="co">#&gt;  1    0.695      0.468      0.504 regLogistic   100</span></a>
<a class="sourceLine" id="cb6-7" title="7"><span class="co">#&gt;  2    0.644      0.618      0.616 regLogistic   101</span></a>
<a class="sourceLine" id="cb6-8" title="8"><span class="co">#&gt;  3    0.665      0.553      0.606 regLogistic   102</span></a>
<a class="sourceLine" id="cb6-9" title="9"><span class="co">#&gt;  4    0.643      0.655      0.646 regLogistic   103</span></a>
<a class="sourceLine" id="cb6-10" title="10"><span class="co">#&gt;  5    0.648      0.618      0.644 regLogistic   104</span></a>
<a class="sourceLine" id="cb6-11" title="11"><span class="co">#&gt;  6    0.736      0.470      0.469 rf            100</span></a>
<a class="sourceLine" id="cb6-12" title="12"><span class="co">#&gt;  7    0.723      0.593      0.543 rf            101</span></a>
<a class="sourceLine" id="cb6-13" title="13"><span class="co">#&gt;  8    0.696      0.637      0.656 rf            102</span></a>
<a class="sourceLine" id="cb6-14" title="14"><span class="co">#&gt;  9    0.678      0.647      0.636 rf            103</span></a>
<a class="sourceLine" id="cb6-15" title="15"><span class="co">#&gt; 10    0.685      0.629      0.614 rf            104</span></a></code></pre></div>
<p>Visualize the performance results (<code>ggplot2</code> is required):</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1">perf_boxplot &lt;-<span class="st"> </span><span class="kw">plot_performance</span>(perf_df2)</a>
<a class="sourceLine" id="cb7-2" title="2">perf_boxplot</a></code></pre></div>
<p><img src="parallel_files/figure-html/plot_perf-1.png" width="700" /></p>
<p><code>plot_performance()</code> returns a ggplot2 object. You can add layers to customize the plot:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1">perf_boxplot <span class="op">+</span></a>
<a class="sourceLine" id="cb8-2" title="2"><span class="st">   </span><span class="kw">theme_classic</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb8-3" title="3"><span class="st">   </span><span class="kw">scale_color_brewer</span>(<span class="dt">palette =</span> <span class="st">&quot;Dark2&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb8-4" title="4"><span class="st">   </span><span class="kw">coord_flip</span>()</a></code></pre></div>
<p><img src="parallel_files/figure-html/customize_plot-1.png" width="700" /></p>
<p>You can also create your own plots however you like using the performance results.</p>
</div>
</div>
<div id="parallelizing-with-snakemake" class="section level2">
<h2>Parallelizing with Snakemake</h2>
<p>When parallelizing multiple calls to <code>run_ml()</code> in R as in the examples above, all of the results objects are held in memory. This isn’t a big deal for a small dataset run with only a few seeds. However, for large datasets run in parallel with, say, 100 seeds (recommended), you may run into problems trying to store all of those objects in memory at once. One solution is to write the results files of each <code>run_ml()</code> call, then concatenate them at the end. We show one way to accomplish this with Snakemake in <a href="https://github.com/SchlossLab/mikropml-snakemake-workflow">an example Snakemake workflow here</a>.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc">
      <h2 data-toc-skip>Contents</h2>
    </nav>
      </div>

</div>



      <footer>
      <div class="copyright">
  <p>Developed by <a href='https://github.com/BTopcuoglu'>Begüm Topçuoğlu</a>, <a href='https://github.com/pschloss'>Patrick Schloss</a>, <a href='https://github.com/zenalapp'>Zena Lapp</a>, <a href='https://github.com/kelly-sovacool'>Kelly Sovacool</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>

