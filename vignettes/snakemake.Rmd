---
title: "Managing workflows with Snakemake"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Managing workflows with Snakemake}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = TRUE,
  eval = FALSE
)
```
```{r, include=FALSE}
library(knitr)
```

Snakemake is... TODO

## The Workflow

The [`Snakefile`](https://github.com/SchlossLab/mikropml-snakemake-workflow/blob/master/Snakefile) contains rules which define the output files we want and how to make them.
Snakemake automatically figures out the dependencies of each of the rules and
what order to run them in.

This Snakemake workflow preprocesses the dataset 
([`data/otu_large.csv`](https://github.com/SchlossLab/mikropml-snakemake-workflow/blob/master/data/otu_large.csv)) with `mikropml::preprocess_data()`,
calls `mikropml::run_ml()` for each seed and ML method set in 
[ `config/config.yml`](https://github.com/SchlossLab/mikropml-snakemake-workflow/blob/master/config/config.yml),
combines the results files, plots performance results, and renders a simple 
[R Markdown report](https://github.com/SchlossLab/mikropml-snakemake-workflow/blob/master/Snakefile/report.Rmd) 
as a GitHub-flavored [markdown file](https://github.com/SchlossLab/mikropml-snakemake-workflow/blob/master/report.md).

![](https://raw.githubusercontent.com/SchlossLab/mikropml-snakemake-workflow/master/figures/rulegraph.png)


## Setup

1. Clone or download the [mikropml-snakemake-workflow](https://github.com/SchlossLab/mikropml-snakemake-workflow) repo.

    ```{sh}
    git clone https://github.com/SchlossLab/mikropml-snakemake-workflow
    cd mikropml-snakemake-workflow
    ```

1. Install snakemake.

    We recommend using conda (see 
    [miniconda installation here](https://docs.conda.io/en/latest/miniconda.html)) 
    to install Snakemake and its dependencies. 
    Create a conda environment and activate it with:
    
    ```{sh}
    conda env create -f config/environment.yml
    conda activate smk-ML
    ```
    
    Alternatively, you can 
    [install snakemake](https://snakemake.readthedocs.io/en/stable/getting_started/installation.html) 
    and the other dependencies listed in `config/environment.yml` however you like.
    
1. Install the mikropml R package: see the [mikropml install instructions](https://github.com/SchlossLab/mikropml#installation).

    e.g.
    ```{sh}
    R -e 'devtools::install_github("SchlossLab/mikropml")'
    ```
1. Edit the configuration file [`config/config.yml`](https://github.com/SchlossLab/mikropml-snakemake-workflow/blob/master/config/config.yml).
    - `ml_methods`: list of machine learning methods to use. Must be supported by mikropml.
    - `ncores`: the number of cores to use for preprocessing and for each `mikropml::run_ml()` call. Do not exceed the number of cores you have available.
    - `nseeds`: the number of different random seeds to use for training models with `mikropml::run_ml()`.

1. Do a dry run to make sure the snakemake workflow is valid.
    ```{sh}
    snakemake -n
    ```
1. Run the workflow.

    Run it locally with:
    ```{sh}
    snakemake
    ```

    To run the workflow on an HPC with SLURM:

    1. Edit your email (`YOUR_EMAIL_HERE`) and SLURM account (`YOUR_ACCOUNT_HERE`) in:
        - [`code/submit_slurm.sh`](https://github.com/SchlossLab/mikropml-snakemake-workflow/blob/master/code/submit_slurm.sh)
        - [`config/cluster.json`](https://github.com/SchlossLab/mikropml-snakemake-workflow/blob/master/config/cluster.json)
    1. Submit the snakemake workflow with:
        ``` Âµsh
        sbatch code/submit_slurm.sh
        ```
        The main job will then submit other snakemake jobs.
1. View the results in [`report.md`](https://github.com/SchlossLab/mikropml-snakemake-workflow/blob/master/report.md).

## Resources

- [Snakemake docs](https://snakemake.readthedocs.io/en/stable)
- [mikropml docs](http://www.schlosslab.org/mikropml/)
